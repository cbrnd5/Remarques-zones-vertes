<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme de Recensement - MEL & Centrale Lille</title>
    <!-- Using Google Maps JavaScript API for the interactive map; Leaflet styles removed -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cambria Math', Cambria, serif;
            background: linear-gradient(135deg, #c31432 0%, #8b0a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #c31432 0%, #8b0a1a 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content {
            flex: 1;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        header p {
            font-size: 1.05em;
            opacity: 0.95;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .logos {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .logo-item {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            color: #c31432;
            font-size: 1.2em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .logo-item img {
            height: 38px;
            width: auto;
            display: block;
        }
        .logo-item.logo-centrale img {
            height: 56px;
        }

        .user-points {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-points .points-value {
            font-size: 2em;
            font-weight: bold;
        }

        .user-points .points-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .map-section {
            padding: 30px;
            background: #f8f9fa;
            border-right: 3px solid #c31432;
        }

        .map-section h2 {
            color: #c31432;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .map-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #c31432;
        }

        .map-info strong {
            color: #c31432;
        }

        #map {
            height: 550px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #c31432;
        }

        .form-section {
            padding: 30px;
        }

        .form-section h2 {
            color: #c31432;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 1.05em;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #c31432;
        }

        .form-group select {
            background: white;
            cursor: pointer;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .theme-option {
            position: relative;
        }

        .theme-option input[type="radio"] {
            display: none;
        }

        .theme-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .theme-label .label {
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .theme-option input[type="radio"]:checked + .theme-label {
            border-color: #c31432;
            background: #fff5f5;
            transform: scale(1.05);
        }

        .theme-label:hover {
            border-color: #c31432;
            background: #fff5f5;
        }

        .photo-upload {
            border: 2px dashed #c31432;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fff5f5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            background: #ffe5e5;
            border-color: #8b0a1a;
        }

        .photo-upload input {
            display: none;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #c31432;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #c31432 0%, #8b0a1a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(195, 20, 50, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(195, 20, 50, 0.4);
        }

        .admin-link {
            position: fixed;
            bottom: 18px;
            right: 18px;
            background: linear-gradient(135deg, #c31432 0%, #8b0a1a 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            z-index: 1000;
        }

        .admin-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }

        /* Map-only quick link (aligned with admin link) */
        .map-link {
            position: fixed;
            bottom: 76px; /* stacked above admin link */
            right: 18px;
            background: linear-gradient(135deg, #c31432 0%, #8b0a1a 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 0.95rem;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 6px 14px rgba(195, 20, 50, 0.28);
            transition: transform 0.15s;
            z-index: 1000;
        }

        .map-link:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(195, 20, 50, 0.4); }

        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .alert {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            border-left: 5px solid #4CAF50;
        }

        .alert-error {
            border-left: 5px solid #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .char-counter {
            text-align: right;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #c31432;
            font-weight: bold;
        }

        .previous-comments {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }

        .previous-comments h3 {
            color: #c31432;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .comment-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #c31432;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-date {
            color: #666;
            font-size: 0.9em;
        }

        .comment-theme {
            background: #c31432;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .comment-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .comment-photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .comment-photos img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            cursor: pointer;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .zone-tooltip {
            background: #c31432 !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            padding: 5px 10px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
        }

        /* Leaflet-specific tooltip arrow rules removed; Google Maps uses its own UI */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Recensement du Mobilier Urbain</h1>
                <p>Aidez-nous à améliorer notre territoire - Zone Basse Deûle et Lys</p>
            </div>
            <div class="header-right">
                <div class="logos">
                    <div class="logo-item"><img src="images/logo-mel_0.jpg" alt="MEL logo"></div>
                    <div class="logo-item logo-centrale"><img src="images/centrale-lille-logo.jpg" alt="Centrale Lille logo"></div>
                </div>
                <div class="user-points">
                    <div>
                        <div class="points-value" id="userPoints">0</div>
                        <div class="points-label">points</div>
                    </div>
                    
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="map-section">
                <h2>Sélectionnez une zone</h2>
                <div class="map-info">
                    <strong>Instructions :</strong> Cliquez sur une zone de la carte pour la sélectionner et partager vos observations.
                </div>
                <div id="map"></div>
            </div>

            <div class="form-section">
                <h2>Votre contribution</h2>
                <form id="feedbackForm">
                    <div class="form-group">
                        <label>Zone sélectionnée</label>
                        <input type="text" id="zoneName" readonly placeholder="Cliquez sur la carte pour sélectionner une zone">
                    </div>

                    <div class="form-group">
                        <label>Type de mobilier urbain *</label>
                        <div class="theme-selector">
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme1" value="Banc">
                                <label for="theme1" class="theme-label">
                                    <span class="label">Banc</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme2" value="Table">
                                <label for="theme2" class="theme-label">
                                    <span class="label">Table</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme3" value="Poteau(x)">
                                <label for="theme3" class="theme-label">
                                    <span class="label">Poteau(x)</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme4" value="Panneau">
                                <label for="theme4" class="theme-label">
                                    <span class="label">Panneau</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme5" value="Pont">
                                <label for="theme5" class="theme-label">
                                    <span class="label">Pont</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme6" value="Barrière">
                                <label for="theme6" class="theme-label">
                                    <span class="label">Barrière</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme7" value="Escalier">
                                <label for="theme7" class="theme-label">
                                    <span class="label">Escalier</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme8" value="Poubelle">
                                <label for="theme8" class="theme-label">
                                    <span class="label">Poubelle</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme9" value="Lampadaire">
                                <label for="theme9" class="theme-label">
                                    <span class="label">Lampadaire</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme10" value="Mobilier de sport">
                                <label for="theme10" class="theme-label">
                                    <span class="label">Mobilier de sport</span>
                                </label>
                            </div>
                            <div class="theme-option">
                                <input type="radio" name="theme" id="theme11" value="Autre">
                                <label for="theme11" class="theme-label">
                                    <span class="label">Autre</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="comment">Description (optionnel)</label>
                        <textarea id="comment" placeholder="Décrivez le mobilier, son état, son emplacement..." maxlength="1000"></textarea>
                        <div class="char-counter" id="charCounter">0 / 1000 caractères</div>
                    </div>

                    <div class="form-group">
                        <label>Photos (max 3)</label>
                        <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                            <input type="file" id="photoInput" accept="image/*" multiple>
                            <p style="font-size: 1.2em; margin-bottom: 10px;">Cliquez pour ajouter des photos</p>
                            <p style="color: #666; font-size: 0.9em;">JPG, PNG - Maximum 3 photos</p>
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>

                    <button type="submit" class="submit-btn">Envoyer ma contribution</button>
                </form>

                <div class="previous-comments" id="previousComments" style="display: none;">
                    <h3>Contributions précédentes pour cette zone</h3>
                    <div id="commentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <a href="map-only.html" class="map-link">Carte (filtrer)</a>
    <a href="index.html" class="admin-link">Tableau récapitulatif</a>

    <div id="alertContainer" class="alert-container"></div>

    <div class="modal" id="imageModal" onclick="this.classList.remove('active')">
        <div class="modal-content">
            <span class="modal-close" onclick="event.stopPropagation(); this.parentElement.parentElement.classList.remove('active')">×</span>
            <img id="modalImage" src="" alt="Image agrandie">
        </div>
    </div>

    <script>
        // Points système
        let userPoints = parseInt(localStorage.getItem('userPoints') || '0');
        document.getElementById('userPoints').textContent = userPoints;

        // MEL boundary (as used in the previously working file)
        const melBoundary = [
            {lat:50.735, lng:2.920}, {lat:50.735, lng:3.000}, {lat:50.710, lng:3.080}, {lat:50.690, lng:3.185},
            {lat:50.650, lng:3.210}, {lat:50.615, lng:3.180}, {lat:50.585, lng:3.145}, {lat:50.560, lng:3.095},
            {lat:50.545, lng:3.040}, {lat:50.540, lng:2.995}, {lat:50.545, lng:2.950}, {lat:50.565, lng:2.915},
            {lat:50.620, lng:2.890}, {lat:50.680, lng:2.880}, {lat:50.715, lng:2.895}, {lat:50.735, lng:2.920}
        ];

        // Grid and marker settings
        const gridRows = 30;
        const gridCols = 50;
        const MARKER_VISIBLE_ZOOM = 15;
        const MARKER_SIZE = 24;

        let map;
        let zones = [];
        let selectedZone = null;
        let currentMarker = null;
        let feedbackData = JSON.parse(localStorage.getItem('feedbackData') || '[]');
        let mapMarkers = [];
        let selectedPhotos = [];

        // Geometry helpers
        function isPointInPolygon(point, polygon) {
            const x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function rectangleIntersectsPolygon(rectBounds, polygon) {
            const corners = [
                [rectBounds[0][0], rectBounds[0][1]],
                [rectBounds[1][0], rectBounds[1][1]],
                [rectBounds[2][0], rectBounds[2][1]],
                [rectBounds[3][0], rectBounds[3][1]]
            ];
            for (let corner of corners) if (isPointInPolygon(corner, polygon)) return true;
            const centerLat = (rectBounds[0][0] + rectBounds[2][0]) / 2;
            const centerLng = (rectBounds[0][1] + rectBounds[2][1]) / 2;
            if (isPointInPolygon([centerLat, centerLng], polygon)) return true;
            return false;
        }

        // Map initialization
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat:50.6292, lng:3.0573},
                zoom: 11,
                mapTypeId: 'roadmap',
                gestureHandling: 'greedy'
            });

            // MEL boundary polygon removed to avoid drawing the outer contour
            // (previously created from `melBoundary`).

            const boundsObj = new google.maps.LatLngBounds();
            melBoundary.forEach(pt => boundsObj.extend(pt));
            map.fitBounds(boundsObj);

            map.addListener('zoom_changed', function() {
                const z = map.getZoom();
                mapMarkers.forEach(m => m.setVisible(z >= MARKER_VISIBLE_ZOOM));
            });

            // --- New: Use provided GeoJSON study zone to adapt the grid ---
            const studyGeoJSON = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "nom": "Zone d'étude - Basse Deûle et Lys",
                            "description": "Polygone basé sur tableau de vecteurs fourni"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [
                                [
                                    [3.14, 50.76],
                                    [3.18, 50.76],
                                    [3.13, 50.80],
                                    [2.99, 50.78],
                                    [2.86, 50.70],
                                    [2.82, 50.69],
                                    [2.80, 50.65],
                                    [2.99, 50.69],
                                    [2.99, 50.70],
                                    [3.05, 50.65],
                                    [3.02, 50.63],
                                    [3.05, 50.63],
                                    [3.08, 50.65],
                                    [3.05, 50.71],
                                    [2.98, 50.72],
                                    [3.12, 50.75],
                                    [3.14, 50.76]
                                ]
                            ]
                        }
                    }
                ]
            };

            // Convert GeoJSON polygon to array of {lat,lng} for drawing and checks
            const studyCoords = studyGeoJSON.features[0].geometry.coordinates[0].map(c => ({lat: c[1], lng: c[0]}));

            const studyPolygon = new google.maps.Polygon({
                paths: studyCoords,
                strokeColor: '#0055a5',
                strokeOpacity: 0.9,
                strokeWeight: 2,
                fillColor: '#0055a5',
                fillOpacity: 0.08,
                clickable: false,
                map: map
            });
            // Put study polygon above the MEL overlay and fit map to it
            studyPolygon.setOptions({zIndex: 5, fillOpacity: 0.12});
            const studyBounds = new google.maps.LatLngBounds();
            studyCoords.forEach(pt => studyBounds.extend(pt));
            map.fitBounds(studyBounds);

            // Helper: point-in-polygon using lon/lat (ray-casting)
            function pointInPolygon(lat, lng, polygonLatLngArray) {
                const x = lng, y = lat;
                let inside = false;
                for (let i = 0, j = polygonLatLngArray.length - 1; i < polygonLatLngArray.length; j = i++) {
                    const xi = polygonLatLngArray[i].lng, yi = polygonLatLngArray[i].lat;
                    const xj = polygonLatLngArray[j].lng, yj = polygonLatLngArray[j].lat;
                    const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            }

            // Compute grid over study bounding box (adapte le quadrillage à la zone d'étude)
            const lats = studyCoords.map(p => p.lat);
            const lngs = studyCoords.map(p => p.lng);
            const minLat = Math.min(...lats), maxLat = Math.max(...lats);
            const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);
            const latStep = (maxLat - minLat) / gridRows;
            const lngStep = (maxLng - minLng) / gridCols;

            let zoneNumber = 1;
            for (let row = 0; row < gridRows; row++) {
                for (let col = 0; col < gridCols; col++) {
                    const sw = {lat: minLat + (row * latStep), lng: minLng + (col * lngStep)};
                    const se = {lat: minLat + (row * latStep), lng: minLng + ((col + 1) * lngStep)};
                    const ne = {lat: minLat + ((row + 1) * latStep), lng: minLng + ((col + 1) * lngStep)};
                    const nw = {lat: minLat + ((row + 1) * latStep), lng: minLng + (col * lngStep)};

                    const center = {lat: (sw.lat + ne.lat) / 2, lng: (sw.lng + ne.lng) / 2};

                    // only create grid cell if its center falls inside the study polygon
                    if (!pointInPolygon(center.lat, center.lng, studyCoords)) continue;

                    const zoneCoords = [sw, se, ne, nw];
                    const zoneId = `Zone ${zoneNumber.toString().padStart(3, '0')}`;

                    const zonePolygon = new google.maps.Polygon({
                        paths: zoneCoords,
                        strokeColor: '#c31432',
                        strokeOpacity: 0.3,
                        strokeWeight: 0.5,
                        fillColor: '#ffffff',
                        fillOpacity: 0.05,
                        clickable: true,
                        zIndex: 2,
                        map: map
                    });

                    zonePolygon.zoneId = zoneId;
                    zonePolygon.zoneBounds = zoneCoords;

                    zonePolygon.addListener('click', function(e) {
                        selectZone(this.zoneId, this.zoneBounds, e.latLng);
                    });

                    zonePolygon.addListener('mouseover', function() {
                        if (this.zoneId !== selectedZone) this.setOptions({fillColor: '#c31432', fillOpacity: 0.2});
                        if (map && map.getDiv) map.getDiv().style.cursor = 'pointer';
                    });

                    zonePolygon.addListener('mouseout', function() {
                        if (this.zoneId !== selectedZone) this.setOptions({fillColor: '#ffffff', fillOpacity: 0.05});
                        if (map && map.getDiv) map.getDiv().style.cursor = '';
                    });

                    zones.push({id: zoneId, polygon: zonePolygon, bounds: zoneCoords});
                    zoneNumber++;
                }
            }

            // Map click fallback
            map.addListener('click', function(e) {
                const lat = e.latLng.lat(); const lng = e.latLng.lng();
                for (let z of zones) {
                    const bounds = z.bounds;
                    const minLatZ = Math.min(...bounds.map(p => p.lat));
                    const maxLatZ = Math.max(...bounds.map(p => p.lat));
                    const minLngZ = Math.min(...bounds.map(p => p.lng));
                    const maxLngZ = Math.max(...bounds.map(p => p.lng));
                    if (lat >= minLatZ && lat <= maxLatZ && lng >= minLngZ && lng <= maxLngZ) {
                        selectZone(z.id, z.bounds, e.latLng); return;
                    }
                }
            });

            // draw markers from storage
            drawExistingMarkers();
        }

        function selectZone(zoneId, bounds, latlng) {
            zones.forEach(z => z.polygon.setOptions({fillColor: '#ffffff', fillOpacity: 0.05}));
            const found = zones.find(z => z.id === zoneId);
            if (found) found.polygon.setOptions({fillColor: '#c31432', fillOpacity: 0.5});
            selectedZone = zoneId;
            document.getElementById('zoneName').value = zoneId;

            if (currentMarker) currentMarker.setMap(null);
            currentMarker = new google.maps.Marker({position: latlng, map: map, icon: {path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#c31432', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 3}});

            showPreviousComments(zoneId);
        }

        function createLabelMarker(theme, position) {
            const label = String(theme).replace(/</g, '').replace(/>/g, '');
            const initial = label ? label.charAt(0).toUpperCase() : '';
            const size = MARKER_SIZE;
            const svg = `<?xml version="1.0" encoding="UTF-8"?><svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>\n                <circle cx='${size/2}' cy='${size/2}' r='${Math.floor(size/2)-2}' fill='#c31432' />\n                <text x='${size/2}' y='${size/2+4}' font-family='Cambria Math, Cambria, serif' font-size='12' fill='white' text-anchor='middle'>${initial}</text>\n            </svg>`;
            const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
            const marker = new google.maps.Marker({position: position, map: map, title: label, visible: map.getZoom ? (map.getZoom() >= MARKER_VISIBLE_ZOOM) : false, optimized: false, icon: {url: url, scaledSize: new google.maps.Size(size, size), anchor: new google.maps.Point(Math.round(size/2), size)}});
            return marker;
        }

        function drawExistingMarkers() {
            if (!map) return;
            mapMarkers.forEach(m => m.setMap(null)); mapMarkers = [];
            feedbackData.forEach(f => {
                if (f.coords && typeof f.coords.lat === 'number' && typeof f.coords.lng === 'number') {
                    const pos = new google.maps.LatLng(f.coords.lat, f.coords.lng);
                    const m = createLabelMarker(f.theme, pos); mapMarkers.push(m);
                }
            });
        }

        function showPreviousComments(zoneId) {
            const zoneComments = feedbackData.filter(f => f.zone === zoneId);
            const commentsSection = document.getElementById('previousComments');
            const commentsList = document.getElementById('commentsList');
            if (zoneComments.length === 0) { commentsSection.style.display = 'none'; return; }
            commentsSection.style.display = 'block';
            commentsList.innerHTML = zoneComments.map(comment => `\n                <div class="comment-item">\n                    <div class="comment-header">\n                        <div class="comment-date">${comment.date}</div>\n                        <div class="comment-theme">${comment.theme}</div>\n                    </div>\n                    <div class="comment-text">${comment.comment}</div>\n                    ${comment.photos.length > 0 ? `\n                        <div class="comment-photos">\n                            ${comment.photos.map(photo => `\n                                <img src="${photo}" alt="Photo" onclick="showImageModal('${photo}')">\n                            `).join('')}\n                        </div>\n                    ` : ''}\n                </div>\n            `).join('');
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (selectedPhotos.length + files.length > 3) { showAlert('Vous ne pouvez ajouter que 3 photos maximum', 'error'); return; }
            files.forEach(file => { if (selectedPhotos.length < 3) { const reader = new FileReader(); reader.onload = function(event) { selectedPhotos.push({ file: file, dataUrl: event.target.result }); updatePhotoPreview(); }; reader.readAsDataURL(file); } });
        });

        function updatePhotoPreview() { const preview = document.getElementById('photoPreview'); preview.innerHTML = ''; selectedPhotos.forEach((photo, index) => { const photoItem = document.createElement('div'); photoItem.className = 'photo-item'; photoItem.innerHTML = `\n                    <img src="${photo.dataUrl}" alt="Photo ${index + 1}" onclick="showImageModal('${photo.dataUrl}')">\n                    <button class="remove-btn" onclick="removePhoto(${index})" type="button">×</button>\n                `; preview.appendChild(photoItem); }); }

        function removePhoto(index) { selectedPhotos.splice(index, 1); updatePhotoPreview(); }
        function showImageModal(imageSrc) { document.getElementById('modalImage').src = imageSrc; document.getElementById('imageModal').classList.add('active'); }

        document.getElementById('comment').addEventListener('input', function() { const counter = document.getElementById('charCounter'); const length = this.value.length; counter.textContent = `${length} / 1000 caractères`; if (length > 900) { counter.classList.add('warning'); } else { counter.classList.remove('warning'); } });

        document.getElementById('feedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const zoneId = document.getElementById('zoneName').value; const comment = document.getElementById('comment').value; const theme = document.querySelector('input[name="theme"]:checked');
            if (!zoneId) { showAlert('Veuillez sélectionner une zone sur la carte', 'error'); return; }
            if (!theme) { showAlert('Veuillez sélectionner un type de mobilier urbain', 'error'); return; }
            const coords = currentMarker && currentMarker.getPosition ? currentMarker.getPosition().toJSON() : null;
            const feedback = { id: Date.now(), zone: zoneId, theme: theme.value, date: new Date().toLocaleString('fr-FR'), comment: comment, photos: selectedPhotos.map(p => p.dataUrl), coords: coords };
            feedbackData.push(feedback); localStorage.setItem('feedbackData', JSON.stringify(feedbackData));
            userPoints++; localStorage.setItem('userPoints', userPoints.toString()); document.getElementById('userPoints').textContent = userPoints;
            if (coords) { const m = createLabelMarker(theme.value, new google.maps.LatLng(coords.lat, coords.lng)); mapMarkers.push(m); }
            showAlert('Contribution enregistrée avec succès ! +1 point', 'success'); document.getElementById('feedbackForm').reset(); selectedPhotos = []; updatePhotoPreview(); showPreviousComments(zoneId);
        });

    




        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDH7Dnfyxt9no0sewA_Z2GL_1UZz-oiOo&callback=initMap"></script>
</body>
</html>
